name: ETF Premium Rate Report

on:
  schedule:
    # é»˜è®¤æ¯å¤© UTC æ—¶é—´ 3:00 (åŒ—äº¬æ—¶é—´ 11:00) è¿è¡Œ
    # å®é™…æ—¶é—´ä» config.yaml ä¸­è¯»å–ï¼Œä½† GitHub Actions çš„ cron éœ€è¦åœ¨è¿™é‡Œè®¾ç½®
    - cron: '*/5 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config.yaml from Secrets
      run: |
        # ä» GitHub Secrets ç”Ÿæˆé…ç½®æ–‡ä»¶
        RECIPIENTS="${{ secrets.EMAIL_RECIPIENTS }}"
        
        # ç”Ÿæˆ config.yaml
        echo "email:" > config.yaml
        echo "  smtp:" >> config.yaml
        echo "    host: \"${{ secrets.EMAIL_SMTP_HOST || 'smtp.qq.com' }}\"" >> config.yaml
        echo "    port: ${{ secrets.EMAIL_SMTP_PORT || 587 }}" >> config.yaml
        echo "    use_tls: ${{ secrets.EMAIL_SMTP_USE_TLS != 'false' }}" >> config.yaml
        echo "    username: \"${{ secrets.EMAIL_USERNAME || '' }}\"" >> config.yaml
        echo "    password: \"${{ secrets.EMAIL_PASSWORD || '' }}\"" >> config.yaml
        echo "  recipients:" >> config.yaml
        if [ -n "$RECIPIENTS" ]; then
          # å¤„ç†å¤šä¸ªæ”¶ä»¶äººï¼ˆç”¨é€—å·åˆ†éš”ï¼Œè½¬æ¢ä¸º YAML åˆ—è¡¨æ ¼å¼ï¼‰
          echo "$RECIPIENTS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$' | sed 's/^/    - "/;s/$/"/' >> config.yaml
        else
          echo "    []" >> config.yaml
          echo "â„¹ï¸  EMAIL_RECIPIENTS æœªé…ç½®ï¼Œå°†å°è¯•ä»ä»“åº“ä¸­çš„ config.yaml è¯»å–æ”¶ä»¶äºº" >&2
        fi
        echo "  subject: \"${{ secrets.EMAIL_SUBJECT || 'ğŸ“Š ETF/LOFæº¢ä»·ç‡æ’è¡Œæ¦œ - {date}' }}\"" >> config.yaml
        echo "report:" >> config.yaml
        echo "  top_n: ${{ secrets.REPORT_TOP_N || 100 }}" >> config.yaml
        echo "  only_premium: ${{ secrets.REPORT_ONLY_PREMIUM == 'true' }}" >> config.yaml
        echo "schedule:" >> config.yaml
        echo "  hour: ${{ secrets.SCHEDULE_HOUR || 2 }}" >> config.yaml
        echo "  minute: ${{ secrets.SCHEDULE_MINUTE || 0 }}" >> config.yaml
        echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
        
    - name: Generate and send ETF Premium Rate Report
      run: |
        python src/etf_premium_rate.py

