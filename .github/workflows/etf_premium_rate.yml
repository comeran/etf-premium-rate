name: ETF Premium Rate Report

on:
  schedule:
    # é»˜è®¤æ¯å¤© UTC æ—¶é—´ 2:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    # å®žé™…æ—¶é—´ä»Ž config.yaml ä¸­è¯»å–ï¼Œä½† GitHub Actions çš„ cron éœ€è¦åœ¨è¿™é‡Œè®¾ç½®
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config.yaml from Secrets
      run: |
        # ä»Ž GitHub Secrets ç”Ÿæˆé…ç½®æ–‡ä»¶
        # å¦‚æžœ EMAIL_RECIPIENTS å­˜åœ¨ï¼Œå¤„ç†æ”¶ä»¶äººåˆ—è¡¨
        RECIPIENTS="${{ secrets.EMAIL_RECIPIENTS }}"
        
        if [ -n "$RECIPIENTS" ]; then
          # å¤„ç†å¤šä¸ªæ”¶ä»¶äººï¼ˆç”¨é€—å·åˆ†éš”ï¼Œè½¬æ¢ä¸º YAML åˆ—è¡¨æ ¼å¼ï¼‰
          RECIPIENTS_YAML=$(echo "$RECIPIENTS" | sed 's/, */\n            - /g' | sed 's/^/            - /')
          RECIPIENTS_SECTION="          recipients:
        $RECIPIENTS_YAML"
        else
          # å¦‚æžœ EMAIL_RECIPIENTS ä¸å­˜åœ¨ï¼Œç•™ç©ºï¼Œä»£ç ä¼šä»Žä»“åº“ä¸­çš„ config.yaml è¯»å–
          RECIPIENTS_SECTION="          recipients: []"
          echo "â„¹ï¸  EMAIL_RECIPIENTS æœªé…ç½®ï¼Œå°†å°è¯•ä»Žä»“åº“ä¸­çš„ config.yaml è¯»å–æ”¶ä»¶äºº"
        fi
        
        # ç”Ÿæˆ config.yamlï¼ˆå³ä½¿æŸäº› Secrets ä¸å­˜åœ¨ï¼Œä¹Ÿç”Ÿæˆéƒ¨åˆ†é…ç½®ï¼‰
        cat > config.yaml << EOF
        email:
          smtp:
            host: "${{ secrets.EMAIL_SMTP_HOST || 'smtp.qq.com' }}"
            port: ${{ secrets.EMAIL_SMTP_PORT || 587 }}
            use_tls: ${{ secrets.EMAIL_SMTP_USE_TLS != 'false' }}
            username: "${{ secrets.EMAIL_USERNAME || '' }}"
            password: "${{ secrets.EMAIL_PASSWORD || '' }}"
        $RECIPIENTS_SECTION
          subject: "${{ secrets.EMAIL_SUBJECT || 'ðŸ“Š ETF/LOFæº¢ä»·çŽ‡æŽ’è¡Œæ¦œ - {date}' }}"
        report:
          top_n: ${{ secrets.REPORT_TOP_N || 100 }}
          only_premium: ${{ secrets.REPORT_ONLY_PREMIUM == 'true' }}
        schedule:
          hour: ${{ secrets.SCHEDULE_HOUR || 2 }}
          minute: ${{ secrets.SCHEDULE_MINUTE || 0 }}
        EOF
        echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
        
    - name: Generate and send ETF Premium Rate Report
      run: |
        python src/etf_premium_rate.py

