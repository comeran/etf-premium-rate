name: ETF Premium Rate Report

on:
  schedule:
    # é»˜è®¤æ¯å¤© UTC æ—¶é—´ 2:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    # å®é™…æ—¶é—´ä» config.yaml ä¸­è¯»å–ï¼Œä½† GitHub Actions çš„ cron éœ€è¦åœ¨è¿™é‡Œè®¾ç½®
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config.yaml from Secrets
      run: |
        # ä» GitHub Secrets ç”Ÿæˆé…ç½®æ–‡ä»¶
        RECIPIENTS="${{ secrets.EMAIL_RECIPIENTS }}"
        
        # ç”Ÿæˆ config.yaml
        {
          echo "email:"
          echo "  smtp:"
          echo "    host: \"${{ secrets.EMAIL_SMTP_HOST || 'smtp.qq.com' }}\""
          echo "    port: ${{ secrets.EMAIL_SMTP_PORT || 587 }}"
          echo "    use_tls: ${{ secrets.EMAIL_SMTP_USE_TLS != 'false' }}"
          echo "    username: \"${{ secrets.EMAIL_USERNAME || '' }}\""
          echo "    password: \"${{ secrets.EMAIL_PASSWORD || '' }}\""
          echo "  recipients:"
          if [ -n "$RECIPIENTS" ]; then
            # å¤„ç†å¤šä¸ªæ”¶ä»¶äººï¼ˆç”¨é€—å·åˆ†éš”ï¼Œè½¬æ¢ä¸º YAML åˆ—è¡¨æ ¼å¼ï¼‰
            echo "$RECIPIENTS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$' | sed 's/^/    - "/;s/$/"/'
          else
            echo "    []"
            echo "â„¹ï¸  EMAIL_RECIPIENTS æœªé…ç½®ï¼Œå°†å°è¯•ä»ä»“åº“ä¸­çš„ config.yaml è¯»å–æ”¶ä»¶äºº" >&2
          fi
          echo "  subject: \"${{ secrets.EMAIL_SUBJECT || 'ğŸ“Š ETF/LOFæº¢ä»·ç‡æ’è¡Œæ¦œ - {date}' }}\""
          echo "report:"
          echo "  top_n: ${{ secrets.REPORT_TOP_N || 100 }}"
          echo "  only_premium: ${{ secrets.REPORT_ONLY_PREMIUM == 'true' }}"
          echo "schedule:"
          echo "  hour: ${{ secrets.SCHEDULE_HOUR || 2 }}"
          echo "  minute: ${{ secrets.SCHEDULE_MINUTE || 0 }}"
        } > config.yaml
        echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
        
    - name: Generate and send ETF Premium Rate Report
      run: |
        python src/etf_premium_rate.py

